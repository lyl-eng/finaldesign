# 术语库存储机制说明

## 📂 新的存储结构

### 目录结构
从现在开始，每个翻译项目都有自己独立的目录：

```
{输出目录}/
├── {项目名称1}/
│   ├── cache/
│   │   ├── AinieeCacheData.json      # 包含术语库的完整项目数据
│   │   └── ProjectStatistics.json    # 项目统计信息
│   ├── {项目名称1}_translated.pdf    # 翻译后的文件
│   └── bilingual_pdf/                 # 双语版本（如果启用）
│       └── {项目名称1}_bilingual.pdf
├── {项目名称2}/
│   ├── cache/
│   │   ├── AinieeCacheData.json
│   │   └── ProjectStatistics.json
│   ├── {项目名称2}_translated.txt
│   └── bilingual_txt/
│       └── {项目名称2}_bilingual.txt
└── ...
```

**示例**：
```
D:/fdfile/AiNiee-main/AiNieeOutput/
├── onerec/                            # 项目1
│   ├── cache/
│   │   ├── AinieeCacheData.json
│   │   └── ProjectStatistics.json
│   ├── onerec_translated.pdf          # 翻译结果
│   └── bilingual_pdf/
│       └── onerec_bilingual.pdf       # 双语版本
├── another_doc/                       # 项目2
│   ├── cache/
│   │   ├── AinieeCacheData.json
│   │   └── ProjectStatistics.json
│   └── another_doc_translated.txt
```

**优势**：
- ✅ **一目了然**: 所有项目相关的文件（缓存、翻译结果、双语版本）都在一个目录下
- ✅ **易于管理**: 可以整体复制、移动、备份、删除项目
- ✅ **避免混乱**: 不同项目的文件不会混在一起

## 📤 文件输出位置

### 翻译结果文件
所有翻译相关的文件都会输出到项目独立目录下：

**单语译文** (Translated):
```
{输出目录}/{项目名}/{原文件名}_translated.{扩展名}
```

**双语版本** (Bilingual):
```
{输出目录}/{项目名}/bilingual_{文件类型}/{原文件名}_bilingual.{扩展名}
```

### 文件类型对应的双语目录
不同文件类型的双语版本会存储在不同的子目录：

| 文件类型 | 双语目录 |
|---------|---------|
| PDF | `bilingual_pdf/` |
| TXT | `bilingual_txt/` |
| EPUB | `bilingual_epub/` |
| SRT | `bilingual_srt/` |
| 其他 | `bilingual_auto/` |

### 输出示例
假设翻译 `document.pdf`，项目名为 `document`：

```
AiNieeOutput/
└── document/
    ├── cache/
    │   ├── AinieeCacheData.json         # 缓存和术语库
    │   └── ProjectStatistics.json       # 项目统计
    ├── document_translated.pdf          # 翻译后的PDF
    └── bilingual_pdf/
        └── document_bilingual.pdf       # 双语版PDF
```

### 日志输出
在翻译完成时，会看到如下日志：
```
[INFO] 翻译文件将输出到项目目录: D:\output\document
[INFO] 正在写入文件 D:\output\document\document_translated.pdf, 使用编码: utf-8
[INFO] ✅ 项目数据已保存到独立目录: D:\output\document
[INFO] 翻译结果已保存至项目目录: D:\output\document
```

## 🔍 术语库存储位置

### 1. 内存存储
在 `CacheProject` 对象的 `extra` 字段中：

```python
cache_project.extra["terminology_database"] = {
    "术语1": {
        "term": "术语1",
        "type": "NER",  # 命名实体
        "translation": "Term1",
        "context": "这是术语1出现的上下文",
        "translation_strategy": "直译"
    },
    "Apple": {
        "term": "Apple",
        "type": "domain_term",  # 领域术语
        "translation": "苹果",
        "context": "科技公司名称",
        "translation_strategy": "保留原文"
    },
    # ... 更多术语
}
```

### 2. 磁盘持久化
保存在项目独立目录的缓存文件中：

**文件**: `{输出目录}/{项目名称}/cache/AinieeCacheData.json`

**保存时机**:
- ✅ 每 8 秒自动保存（如有更改）
- ✅ 任务结束时保存
- ✅ 应用关闭时保存
- ✅ 手动保存缓存时

## ✨ 术语库复用机制

### 自动检测与复用
从本次更新开始，系统会智能检测已有术语库：

```
第一次翻译项目：
  → 术语识别Agent开始工作
  → 调用LLM识别术语
  → 构建术语库
  → 保存到 {项目名称}/cache/AinieeCacheData.json

继续翻译或重新翻译：
  → 检测到已有术语库
  → 直接复用，跳过识别步骤 ✅
  → 节省时间和API调用
```

### 日志输出示例

**首次翻译**:
```
阶段2: 术语与实体识别
未检测到术语库，开始智能识别...
→ 执行智能术语识别（NER、领域术语、文化负载词）...
✓ 识别到 45 个潜在术语
→ 执行知识库集成与查证...
✓ 查证完成，确认 38 个术语
→ 构建项目专属术语库...
✓ 术语库构建完成，共 38 个术语
```

**继续翻译**:
```
阶段2: 术语与实体识别
✅ 检测到已有术语库（38 个术语），直接复用
✅ 检测到已有Memory存储，直接复用
```

## 🔄 数据范围与共享

### 每个项目独立
- ✅ **项目级别**: 每个翻译项目有自己的术语库
- ✅ **独立目录**: 不同项目的数据互不干扰
- ✅ **可移植**: 整个项目目录可以复制、备份、共享

### 不支持跨项目共享
- ❌ 项目A的术语库不会自动用于项目B
- ❌ 全局术语库需要手动管理（通过配置文件的 `prompt_dictionary_data`）

## 🛠️ 项目名称清理规则

系统会自动清理项目名称，确保它是有效的目录名：

**规则**:
1. 移除非法字符: `<>:"/\|?*`
2. 移除首尾空格和点号
3. 限制长度为 50 个字符
4. 如果清理后为空，使用 `UnnamedProject`

**示例**:
- `my:project` → `my_project`
- `file<1>.txt` → `file_1_.txt`
- `   test.   ` → `test`

## 🔧 向后兼容性

### 旧项目自动迁移
系统会自动处理旧项目：

```
旧路径:
  {输出目录}/cache/AinieeCacheData.json

新路径:
  {输出目录}/{项目名称}/cache/AinieeCacheData.json

迁移过程:
  1. 检测到旧路径的缓存文件
  2. 加载旧项目数据
  3. 自动保存到新路径
  4. 日志: "从旧路径加载项目"
  5. 日志: "将项目迁移到新路径: {新路径}"
```

### 继续翻译旧项目
- ✅ 旧项目可以正常继续翻译
- ✅ 会自动迁移到新的独立目录结构
- ✅ 不需要手动操作

## 📊 实体一致性保障

### 术语库的作用
术语库用于保证翻译中的实体一致性：

1. **识别**: `TerminologyEntityAgent` 识别文本中的术语
2. **存储**: 术语库保存在 `cache_project.extra["terminology_database"]`
3. **注入**: `TranslationRefinementAgent` 将术语库注入到翻译提示词中
4. **强制**: LLM 按照术语库进行翻译，确保一致性

### 术语类型
- **NER**: 命名实体（人名、地名、组织名）
- **domain_term**: 领域术语（专业词汇）
- **cultural_term**: 文化负载词（需特殊处理的文化相关词汇）

### 翻译策略
- **直译**: 直接翻译
- **音译**: 音译处理
- **保留原文**: 保持原文不变
- **意译**: 意译处理

## 💡 使用建议

### 1. 项目命名
建议使用有意义的文件名，这样项目目录名也会更清晰：
- ✅ `user_manual.pdf` → 项目名: `user_manual`
- ✅ `chapter1.txt`, `chapter2.txt` → 项目名: `chapt&&chapt`
- ❌ `1.txt`, `2.txt` → 项目名: `1&&2` (不够清晰)

### 2. 备份术语库
整个项目目录可以备份：
```bash
# 备份整个项目
cp -r AiNieeOutput/my_project AiNieeOutput/my_project_backup

# 或者只备份缓存
cp AiNieeOutput/my_project/cache/AinieeCacheData.json backup/
```

### 3. 共享术语库
如果需要在多个项目间共享术语，可以：
- 使用配置文件的全局术语表: `Resource/config.json` 中的 `prompt_dictionary_data`
- 或者手动复制 `terminology_database` 到新项目的缓存文件中

### 4. 清理旧项目
系统不会自动删除旧项目，您可以手动清理：
```bash
# 删除不需要的项目
rm -rf AiNieeOutput/old_project
```

### 5. 继续翻译
当您想继续翻译某个项目时：
1. 在GUI中选择"继续翻译"模式
2. 系统会自动扫描项目目录，加载最近的项目
3. 术语库会自动复用，无需重新识别

## 🎯 优势总结

### 新存储机制的优势
1. ✅ **清晰管理**: 每个项目有独立目录，一目了然
2. ✅ **避免混淆**: 不同项目的数据不会互相干扰
3. ✅ **节省资源**: 术语库复用，减少API调用
4. ✅ **可移植**: 项目目录可以整体移动、备份、共享
5. ✅ **向后兼容**: 自动迁移旧项目
6. ✅ **灵活扩展**: 未来可以添加项目级别的配置

### 与原系统的对比

| 特性 | 原系统 | 新系统 |
|------|--------|--------|
| 存储位置 | `output/cache/` | `output/{项目名}/cache/` |
| 项目隔离 | ❌ 所有项目混在一起 | ✅ 每个项目独立目录 |
| 术语库复用 | ❌ 每次重新识别 | ✅ 自动检测并复用 |
| 旧项目兼容 | - | ✅ 自动迁移 |
| 可移植性 | ⚠️ 需要整个cache目录 | ✅ 单个项目目录即可 |

## 🔍 故障排查

### 问题: 找不到项目
**症状**: 继续翻译时提示找不到项目

**解决**:
1. 检查输出目录设置是否正确
2. 查看 `{输出目录}` 下是否有项目子目录
3. 检查项目子目录下的 `cache/AinieeCacheData.json` 是否存在

### 问题: 术语库没有复用
**症状**: 每次都重新识别术语

**检查**:
1. 查看日志，确认是否输出 "检测到已有术语库"
2. 检查缓存文件中是否包含 `terminology_database` 字段
3. 确认是在"继续翻译"模式，而不是"新建项目"模式

### 问题: 项目名称乱码
**症状**: 项目目录名不可读

**解决**:
- 系统会自动清理非法字符
- 如果仍有问题，可以手动重命名项目目录
- 重命名后需要重新加载项目

## 📝 技术实现细节

### CacheManager 修改
- 添加 `_get_project_directory()`: 获取项目独立目录（内部方法）
- 添加 `get_project_output_directory()`: 获取项目输出目录（公共方法）
- 添加 `_sanitize_project_name()`: 清理项目名称
- 修改 `save_to_file()`: 保存到项目独立目录
- 修改 `load_from_file()`: 支持旧路径和新路径

### TaskExecutor 修改
- 修改 `task_manual_export()`: 使用项目独立目录输出
- 修改翻译完成后的输出: 使用项目独立目录
- 修改润色完成后的输出: 使用项目独立目录

### MultiAgentTaskExecutor 修改
- 修改翻译结果输出: 使用项目独立目录

### TerminologyEntityAgent 修改
- 添加术语库检测逻辑
- 如果检测到已有术语库，直接复用
- 如果没有，执行完整的识别流程

### 数据结构
```python
# CacheProject.extra 字段
{
    "terminology_database": {
        "术语1": {...},
        "术语2": {...},
        ...
    },
    "memory_storage": {
        "domain": "科技",
        "style": "正式",
        "translated_texts": [...],
        ...
    },
    "preprocessing_metadata": {
        "domain_keywords": [...],
        "style_features": {...},
        ...
    }
}
```

## 🎉 更新日志

### v1.0 (本次更新)
- ✅ 实现项目独立目录结构
- ✅ 实现术语库自动复用
- ✅ 实现项目名称清理
- ✅ 实现旧项目自动迁移
- ✅ 添加详细的日志输出
- ✅ 翻译结果输出到项目目录
- ✅ 双语版本输出到项目目录
- ✅ 所有项目相关文件统一存储

### 文件输出位置
- **缓存文件**: `{输出目录}/{项目名}/cache/`
- **翻译文件**: `{输出目录}/{项目名}/{文件名}_translated.{ext}`
- **双语文件**: `{输出目录}/{项目名}/bilingual_{type}/{文件名}_bilingual.{ext}`

---

**最后更新**: 2025-12-27
**文档版本**: 1.0

