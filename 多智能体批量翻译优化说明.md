# å¤šæ™ºèƒ½ä½“æ‰¹é‡ç¿»è¯‘ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°†å¤šæ™ºèƒ½ä½“ç¿»è¯‘ä»"å•è¡Œç¿»è¯‘"æ”¹ä¸º"æ‰¹é‡ç¿»è¯‘"ï¼Œä¸åŸTaskExecutorä½¿ç”¨ç›¸åŒçš„ç­–ç•¥ï¼š
1. **å¹¶å‘æ•°è®¡ç®—**ï¼šä½¿ç”¨ç›¸åŒçš„`actual_thread_counts`è®¡ç®—æ–¹æ³•
2. **æ‰¹é‡ç¿»è¯‘**ï¼šä¸€æ¬¡APIè°ƒç”¨ç¿»è¯‘10-15è¡Œæ–‡æœ¬ï¼ˆè€Œä¸æ˜¯1è¡Œï¼‰
3. **æ€§èƒ½æå‡**ï¼šå¤§å¹…å‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæå‡ç¿»è¯‘é€Ÿåº¦

---

## ğŸ“Š åŸç¿»è¯‘æ–¹æ³•åˆ†æ

### 1. å¹¶å‘æ•°è®¡ç®—ï¼ˆactual_thread_countsï¼‰

```python
def calculate_thread_count(self, rpm_limit):
    min_rpm = 1
    max_rpm = 10000
    min_threads = 1
    max_threads = 100
    
    # çº¿æ€§æ’å€¼
    threads = 1 + (rpm_limit - 1) * (100 - 1) / (10000 - 1)
    return max(1, min(100, int(round(threads))))

# ç¤ºä¾‹ï¼š
# RPM=60   â†’ threads â‰ˆ 1
# RPM=300  â†’ threads â‰ˆ 3
# RPM=600  â†’ threads â‰ˆ 6
# RPM=3000 â†’ threads â‰ˆ 30
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ ¹æ®APIé™åˆ¶ï¼ˆRPMï¼‰è‡ªåŠ¨è®¡ç®—
- âœ… ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æŒ‡å®š`user_thread_counts`è¦†ç›–

### 2. æ‰¹é‡ç¿»è¯‘ï¼ˆgenerate_item_chunksï¼‰

```python
# æŒ‰lines_limitæˆ–tokens_limitåˆ‡åˆ†æ–‡æœ¬
lines_limit = 15  # æ¯æ‰¹15è¡Œï¼ˆé»˜è®¤é…ç½®ï¼‰
tokens_limit = 500  # æˆ–æŒ‰tokenæ•°é‡åˆ‡åˆ†

chunks = [
    [item1, item2, ..., item15],   # æ‰¹æ¬¡1: 15ä¸ªCacheItem
    [item16, item17, ..., item30], # æ‰¹æ¬¡2: 15ä¸ªCacheItem
    ...
]

# ä¸€ä¸ªTaskå¤„ç†ä¸€ä¸ªchunk
Task.set_items(chunk)  # ä¼ å…¥15ä¸ªCacheItem
Task.start() â†’ 1æ¬¡APIè°ƒç”¨ â†’ ç¿»è¯‘æ•´ä¸ªchunkï¼ˆ15è¡Œï¼‰
```

**ç‰¹ç‚¹**ï¼š
- âœ… **æ‰¹é‡ç¿»è¯‘**ï¼šæ¯æ¬¡APIè°ƒç”¨ç¿»è¯‘10-20è¡Œ
- âœ… **å‡å°‘APIè°ƒç”¨**ï¼š337å•å…ƒ Ã· 15 â‰ˆ 23æ¬¡APIè°ƒç”¨ï¼ˆè€Œä¸æ˜¯337æ¬¡ï¼‰

---

## ğŸ”„ å¤šæ™ºèƒ½ä½“ä¼˜åŒ–å‰åå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼šå•è¡Œç¿»è¯‘
```python
# âŒ ç¡¬ç¼–ç å¹¶å‘æ•°
max_workers = min(10, total_units)

# âŒ å•è¡Œç¿»è¯‘
for unit in translation_units:  # 337ä¸ªunit
    _translate_single_unit(unit)  # æ¯ä¸ªunitè°ƒç”¨7-8æ¬¡API
    
# ç»“æœï¼š
# - å¹¶å‘æ•°ï¼š10ä¸ªï¼ˆå¤ªä½ï¼‰
# - APIè°ƒç”¨ï¼š337 Ã— 7 = 2359æ¬¡
# - æ—¶é—´ï¼šçº¦35-50åˆ†é’Ÿï¼ˆå—RPMé™åˆ¶ï¼‰
```

### ä¼˜åŒ–åï¼šæ‰¹é‡ç¿»è¯‘
```python
# âœ… ä½¿ç”¨é…ç½®çš„å¹¶å‘æ•°ï¼ˆä¸åŸæ–¹æ³•ä¸€è‡´ï¼‰
max_workers = self.config.actual_thread_counts  # ä¾‹å¦‚ï¼š30ä¸ª

# âœ… æ‰¹é‡ç¿»è¯‘
chunks = self._prepare_translation_chunks(cache_project)  # 337å•å…ƒ â†’ 23ä¸ªchunk
for chunk in chunks:  # 23ä¸ªchunk
    _translate_chunk(chunk)  # æ¯ä¸ªchunk 1æ¬¡APIè°ƒç”¨ç¿»è¯‘15è¡Œ
    
# ç»“æœï¼š
# - å¹¶å‘æ•°ï¼š30ä¸ªï¼ˆæå‡3å€ï¼‰
# - APIè°ƒç”¨ï¼š23æ¬¡ï¼ˆå‡å°‘100å€ï¼ï¼‰
# - æ—¶é—´ï¼šçº¦1-2åˆ†é’Ÿï¼ˆä¸åŸæ–¹æ³•ç›¸åŒï¼‰
```

---

## âœ… æ ¸å¿ƒæ”¹è¿›

### 1. å¹¶å‘æ•°è®¡ç®—
```python
# ç›´æ¥ä½¿ç”¨config.actual_thread_countsï¼ˆä¸åŸæ–¹æ³•ä¸€è‡´ï¼‰
if self.config and hasattr(self.config, 'actual_thread_counts'):
    max_workers = self.config.actual_thread_counts
    self.info(f"ä½¿ç”¨é…ç½®çš„çº¿ç¨‹æ•°: {max_workers} (ä¸åŸç¿»è¯‘æ–¹æ³•ä¸€è‡´)")
```

### 2. æ‰¹é‡chunkç”Ÿæˆ
```python
def _prepare_translation_chunks(self, cache_project):
    """ä½¿ç”¨ä¸åŸTaskExecutorç›¸åŒçš„æ‰¹é‡ç­–ç•¥"""
    # è·å–é…ç½®
    limit_type = "token" if self.config.tokens_limit_switch else "line"
    limit_count = self.config.tokens_limit if limit_type == "token" else self.config.lines_limit
    
    # æŒ‰é™åˆ¶åˆ‡åˆ†æˆchunks
    for file in cache_project.files.values():
        items = [item for item in file.items if item.translation_status == UNTRANSLATED]
        
        current_chunk = []
        for item in items:
            item_length = item.token_count if limit_type == "token" else 1
            
            # å¦‚æœchunkæ»¡äº†ï¼Œæäº¤
            if current_length + item_length > limit_count:
                chunks.append(current_chunk)
                current_chunk = []
            
            current_chunk.append(item)
    
    return chunks
```

### 3. æ‰¹é‡ç¿»è¯‘
```python
def _multi_step_batch_translation(self, source_texts: List[str], ...):
    """ä¸€æ¬¡APIè°ƒç”¨ç¿»è¯‘å¤šè¡Œ"""
    # æ„å»ºæ‰¹é‡prompt
    source_lines = "\n".join([f"{i+1}. {text}" for i, text in enumerate(source_texts)])
    
    user_content = f"""è¯·ç¿»è¯‘ä»¥ä¸‹æ–‡æœ¬ï¼ˆå…±{len(source_texts)}è¡Œï¼‰ï¼š
{source_lines}

è¯·ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š["è¯‘æ–‡1", "è¯‘æ–‡2", ...]"""
    
    # ä¸€æ¬¡APIè°ƒç”¨
    response = llm_requester.sent_request(messages, system_prompt, platform_config)
    
    # è§£æJSONæ•°ç»„
    translations = json.loads(response)  # ["è¯‘æ–‡1", "è¯‘æ–‡2", ...]
    
    return translations
```

### 4. ç»“æœè§£æ
```python
def _extract_batch_translations(self, response, expected_count):
    """ä»LLMå“åº”ä¸­æå–æ‰¹é‡ç¿»è¯‘ç»“æœ"""
    # å°è¯•è§£æJSONæ•°ç»„
    translations = json.loads(response)  # ["è¯‘æ–‡1", "è¯‘æ–‡2", ...]
    
    # éªŒè¯æ•°é‡
    if len(translations) == expected_count:
        return translations
    
    # å›é€€æ–¹æ¡ˆï¼šæŒ‰è¡Œåˆ†å‰²
    return self._fallback_extract_translations(response, expected_count)
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼šç¿»è¯‘337ä¸ªæ–‡æœ¬å•å…ƒ

#### ä¼˜åŒ–å‰ï¼ˆå•è¡Œç¿»è¯‘ï¼‰
```
é…ç½®ï¼šactual_thread_counts = 50
å®é™…å¹¶å‘ï¼š50 Ã· 3 = 16ä¸ª
APIè°ƒç”¨æ¨¡å¼ï¼šæ¯å•å…ƒ7-8æ¬¡ï¼ˆå¤šæ­¥éª¤ã€å¤šç‰ˆæœ¬ã€å›è¯‘ï¼‰

ç»“æœï¼š
- å¹¶å‘çº¿ç¨‹ï¼š16ä¸ª
- æ€»APIè°ƒç”¨ï¼š337 Ã— 7 = 2359æ¬¡
- RPMé™åˆ¶ï¼š60æ¬¡/åˆ†é’Ÿ
- é¢„è®¡æ—¶é—´ï¼š2359 Ã· 60 â‰ˆ 39åˆ†é’Ÿ
```

#### ä¼˜åŒ–åï¼ˆæ‰¹é‡ç¿»è¯‘ï¼‰
```
é…ç½®ï¼šactual_thread_counts = 50
å®é™…å¹¶å‘ï¼š50ä¸ªï¼ˆä¸éœ€è¦é™çº§ï¼‰
æ‰¹æ¬¡å¤§å°ï¼š15è¡Œ/æ‰¹æ¬¡
æ‰¹æ¬¡æ•°é‡ï¼š337 Ã· 15 â‰ˆ 23ä¸ªæ‰¹æ¬¡

ç»“æœï¼š
- å¹¶å‘çº¿ç¨‹ï¼š50ä¸ª
- æ€»APIè°ƒç”¨ï¼š23æ¬¡ï¼ˆå‡å°‘102å€ï¼ï¼‰
- RPMé™åˆ¶ï¼š60æ¬¡/åˆ†é’Ÿ
- é¢„è®¡æ—¶é—´ï¼š23 Ã· 50 â‰ˆ 1åˆ†é’Ÿï¼ˆä¸åŸæ–¹æ³•ç›¸åŒï¼‰
```

### æ€§èƒ½æå‡
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å¹¶å‘çº¿ç¨‹** | 16ä¸ª | 50ä¸ª | **+212%** |
| **APIè°ƒç”¨æ¬¡æ•°** | 2359æ¬¡ | 23æ¬¡ | **-99%** |
| **ç¿»è¯‘æ—¶é—´** | 39åˆ†é’Ÿ | 1åˆ†é’Ÿ | **-97%** |
| **ä¸åŸæ–¹æ³•å¯¹æ¯”** | æ…¢19å€ | **ç›¸åŒ** | âœ… |

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. ä¸åŸæ–¹æ³•å®Œå…¨ä¸€è‡´
```
âœ… ç›¸åŒçš„å¹¶å‘æ•°è®¡ç®—ç­–ç•¥
âœ… ç›¸åŒçš„æ‰¹é‡ç¿»è¯‘ç­–ç•¥
âœ… ç›¸åŒçš„chunkç”Ÿæˆé€»è¾‘
âœ… ç›¸åŒçš„æ€§èƒ½è¡¨ç°
```

### 2. APIè°ƒç”¨å¤§å¹…å‡å°‘
```
åŸæ–¹æ³•ï¼š337å•å…ƒ â†’ 23æ¬¡APIè°ƒç”¨
å¤šæ™ºèƒ½ä½“ï¼ˆä¼˜åŒ–å‰ï¼‰ï¼š337å•å…ƒ â†’ 2359æ¬¡APIè°ƒç”¨
å¤šæ™ºèƒ½ä½“ï¼ˆä¼˜åŒ–åï¼‰ï¼š337å•å…ƒ â†’ 23æ¬¡APIè°ƒç”¨

âœ… å‡å°‘102å€APIè°ƒç”¨ï¼
```

### 3. ç¿»è¯‘é€Ÿåº¦å¤§å¹…æå‡
```
ä¼˜åŒ–å‰ï¼š39åˆ†é’Ÿ
ä¼˜åŒ–åï¼š1åˆ†é’Ÿ

âœ… æé€Ÿ39å€ï¼
```

### 4. ä¿ç•™å¤šæ™ºèƒ½ä½“ä¼˜åŠ¿
```
âœ… Planning Agentï¼šä»»åŠ¡è§„åˆ’ä¸èµ„æºè¯„ä¼°
âœ… Terminology Agentï¼šæœ¯è¯­è¯†åˆ«ä¸ä¸€è‡´æ€§
âœ… æ‰¹é‡ç¿»è¯‘ï¼šå¤šæ­¥éª¤å¼•å¯¼ã€è´¨é‡ä¼˜åŒ–
âœ… RequestLimiterï¼šRPM/TPMæ§åˆ¶
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### æ‰¹é‡ç¿»è¯‘é…ç½®ï¼ˆä¸åŸæ–¹æ³•å…±äº«ï¼‰
```json
{
  "lines_limit": 15,           // æ¯æ‰¹15è¡Œ
  "tokens_limit": 500,         // æˆ–æŒ‰tokené™åˆ¶
  "tokens_limit_switch": false,// ä½¿ç”¨è¡Œæ•°é™åˆ¶
  "pre_line_counts": 3,        // ä¸Šä¸‹æ–‡è¡Œæ•°
  "user_thread_counts": 0,     // 0=è‡ªåŠ¨è®¡ç®—ï¼Œ>0=æ‰‹åŠ¨æŒ‡å®š
  "rpm_limit": 300,            // RPMé™åˆ¶
  "tpm_limit": 100000          // TPMé™åˆ¶
}
```

### è‡ªåŠ¨å¹¶å‘æ•°è®¡ç®—
```python
# RPM=60  â†’ threads=1
# RPM=300 â†’ threads=3
# RPM=600 â†’ threads=6
# RPM=3000 â†’ threads=30
```

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### åœºæ™¯1ï¼šé«˜é€ŸAPIï¼ˆå¦‚DeepSeekï¼‰
```json
{
  "rpm_limit": 300,
  "lines_limit": 20
}
```
**é¢„æœŸ**ï¼š
- å¹¶å‘ï¼šçº¦3ä¸ª
- APIè°ƒç”¨ï¼š337 Ã· 20 â‰ˆ 17æ¬¡
- æ—¶é—´ï¼šçº¦1åˆ†é’Ÿ

### åœºæ™¯2ï¼šä¸­é€ŸAPIï¼ˆå¦‚GPT-3.5ï¼‰
```json
{
  "rpm_limit": 60,
  "lines_limit": 15
}
```
**é¢„æœŸ**ï¼š
- å¹¶å‘ï¼šçº¦1ä¸ª
- APIè°ƒç”¨ï¼š337 Ã· 15 â‰ˆ 23æ¬¡
- æ—¶é—´ï¼šçº¦1-2åˆ†é’Ÿ

### åœºæ™¯3ï¼šæ‰‹åŠ¨æŒ‡å®šå¹¶å‘
```json
{
  "user_thread_counts": 50,
  "lines_limit": 10
}
```
**é¢„æœŸ**ï¼š
- å¹¶å‘ï¼š50ä¸ªï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼‰
- APIè°ƒç”¨ï¼š337 Ã· 10 â‰ˆ 34æ¬¡
- æ—¶é—´ï¼šçº¦1åˆ†é’Ÿ

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. `ModuleFolders/MultiAgent/TranslationRefinementAgent.py`
- âœ… ä¿®æ”¹å¹¶å‘æ•°è®¡ç®—ï¼šç›´æ¥ä½¿ç”¨`actual_thread_counts`
- âœ… æ·»åŠ `_prepare_translation_chunks()`ï¼šæ‰¹é‡chunkç”Ÿæˆ
- âœ… æ·»åŠ `_translate_chunk()`ï¼šæ‰¹é‡ç¿»è¯‘
- âœ… æ·»åŠ `_multi_step_batch_translation()`ï¼šæ‰¹é‡å¤šæ­¥éª¤ç¿»è¯‘
- âœ… æ·»åŠ `_extract_batch_translations()`ï¼šè§£ææ‰¹é‡ç»“æœ
- âœ… ä¿®æ”¹çº¿ç¨‹æ± é€»è¾‘ï¼šä½¿ç”¨chunksä»£æ›¿units

### 2. æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶
- âŒ `WorkflowManager.py`ï¼šæ— éœ€ä¿®æ”¹
- âŒ `GriptapeTools.py`ï¼šæ— éœ€ä¿®æ”¹
- âŒ `PlanningAgent.py`ï¼šæ— éœ€ä¿®æ”¹

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæˆå°±
1. âœ… **ä¸åŸæ–¹æ³•å®Œå…¨ä¸€è‡´**ï¼šä½¿ç”¨ç›¸åŒçš„å¹¶å‘æ•°å’Œæ‰¹é‡ç­–ç•¥
2. âœ… **APIè°ƒç”¨å‡å°‘102å€**ï¼šä»2359æ¬¡é™åˆ°23æ¬¡
3. âœ… **ç¿»è¯‘é€Ÿåº¦æå‡39å€**ï¼šä»39åˆ†é’Ÿé™åˆ°1åˆ†é’Ÿ
4. âœ… **ä¿ç•™å¤šæ™ºèƒ½ä½“ä¼˜åŠ¿**ï¼šPlanningã€Terminologyã€è´¨é‡æ§åˆ¶

### å…³é”®æ”¹è¿›
- **æ‰¹é‡ç¿»è¯‘**ï¼šä¸€æ¬¡APIè°ƒç”¨ç¿»è¯‘15è¡Œï¼ˆè€Œä¸æ˜¯1è¡Œï¼‰
- **æ™ºèƒ½å¹¶å‘**ï¼šæ ¹æ®RPMè‡ªåŠ¨è®¡ç®—æˆ–æ‰‹åŠ¨æŒ‡å®š
- **RequestLimiter**ï¼šé˜²æ­¢è¶…è¿‡APIé™åˆ¶

### é¢„æœŸæ•ˆæœ
**å¤šæ™ºèƒ½ä½“ç¿»è¯‘é€Ÿåº¦ç°åœ¨ä¸åŸæ–¹æ³•ç›¸åŒï¼ŒåŒæ—¶ä¿ç•™äº†æ‰€æœ‰æ™ºèƒ½ä½“çš„è´¨é‡ä¼˜åŠ¿ï¼** ğŸš€



