# TEaR流程术语表强制遵守修复说明

## 🎯 问题根源分析

### 用户洞察
用户发现：**实体一致性问题很可能是在回译阶段改错的**

### 问题循环
```
1. 正向翻译 ✓
   原文: "phosphatidylinositol"
   译文: "磷脂酰肌醇" (正确，遵守术语表)

2. 回译 ✗
   译文: "磷脂酰肌醇"
   回译: "phospholipid inositol" (错误！应该是"phosphatidylinositol")
   
3. 质量评估 ✗
   原文: "phosphatidylinositol"
   回译: "phospholipid inositol"
   评估: "不一致，需要修正"
   
4. 修正 ✗
   LLM: "回译与原文不一致，说明正向翻译有问题"
   修正后: "磷酸肌醇" (错误！改掉了正确的"磷脂酰肌醇")
```

**结果**：正确的翻译被改成了错误的翻译！

---

## ✅ 解决方案：强化整个TEaR流程的术语表遵守

### 修复1: 回译阶段 - 强制术语还原

#### 修改位置
`ModuleFolders/MultiAgent/TranslationRefinementAgent.py` - `_batch_back_translate` (1433-1518行)

#### 修改前
```python
system_prompt = f"""请将以下{target_lang}文本回译为{source_lang}。

{terminology_prompt}

【重要说明】
- 如果译文中包含术语表中的翻译，请在回译时还原为对应的原文术语
- 这样可以帮助验证翻译的准确性
```

**问题**：
- "如果...请..."语气太弱，让LLM觉得是可选的
- 没有强调必须性
- 没有举例说明

#### 修改后
```python
system_prompt = f"""你是一位专业的回译专家。请将以下{target_lang}文本精确回译为{source_lang}。

{terminology_prompt}

🔥【强制要求-术语表严格遵守】🔥
- 术语表中列出的所有译文，必须回译为对应的原文术语，绝不允许替换或改写
- 这是强制性要求，不可违反
- 例如：如果术语表规定"磷脂酰肌醇"必须回译为"phosphatidylinositol"，则绝对不能回译为"phospholipid inositol"或其他任何变体
- 例如：如果术语表规定"Beclin"必须回译为"Beclin"，则必须保持不变
- 例如：如果术语表规定"自噬"必须回译为"autophagy"，则绝对不能回译为"self-phagocytosis"或其他任何替代词
- 术语表的回译规则优先级最高，高于任何语言习惯或同义词

【回译目的】
- 回译是为了验证正向翻译的准确性
- 如果回译无法还原原文术语，说明正向翻译可能有误
- 因此，术语的回译必须100%准确
```

**改进**：
- ✅ 使用"必须"、"绝不允许"等强制性语言
- ✅ 提供3个具体例子
- ✅ 说明回译的目的和重要性
- ✅ 强调术语表优先级最高

---

### 修复2: 质量评估阶段 - 容忍术语表述差异

#### 修改位置
`ModuleFolders/MultiAgent/TranslationRefinementAgent.py` - `_batch_estimate_quality` (1535-1605行)

#### 修改前
```python
system_prompt = """你是一位专业的翻译质量评估专家。请比较原文和回译文，评估每行翻译质量。

评估维度：
1. 语义偏差
2. 逻辑错误
3. 信息遗漏
4. 术语一致性

对于每一行，如果翻译质量良好（评分>=80），输出"0"；如果需要修正（评分<80），输出"1"。
```

**问题**：
- "术语一致性"维度会导致评估器过于严格
- 如果回译术语不一致，会误判为翻译质量差
- 没有说明如何处理术语差异

#### 修改后
```python
system_prompt = """你是一位专业的翻译质量评估专家。请比较原文和回译文，评估每行翻译质量。

评估维度：
1. 语义偏差：回译是否准确还原了原文的含义
2. 逻辑错误：回译是否存在逻辑不通或前后矛盾
3. 信息遗漏：回译是否遗漏了原文的重要信息
4. 整体流畅性：回译是否通顺自然

🔥【重要评估原则-术语容忍】🔥
- 如果回译与原文的差异仅在于专有名词、术语的表述不同，但语义等价，应视为质量良好（不需要修正）
- 例如：原文"phosphatidylinositol"，回译为"phospholipid inositol"，虽然词不同，但语义相近，应视为质量良好
- 例如：原文"autophagy"，回译为"self-eating"或"self-phagocytosis"，虽然词不同，但都指代自噬，应视为质量良好
- 只有当回译的语义完全偏离原文时，才标记为需要修正
- 术语的精确性由正向翻译的术语表保证，回译只需验证语义准确性

【评估标准】
- 如果翻译质量良好（评分>=80，或差异仅为术语表述），输出"0"
- 如果翻译有明显错误（语义偏差、信息遗漏、逻辑错误），输出"1"
```

**改进**：
- ✅ 明确"术语容忍"原则
- ✅ 提供具体例子说明何时应该容忍差异
- ✅ 强调术语精确性由正向翻译保证，回译只验证语义
- ✅ 避免因术语表述差异而过度修正

---

### 修复3: 修正阶段 - 保持术语表不变

#### 修改位置
`ModuleFolders/MultiAgent/TranslationRefinementAgent.py` - `_batch_refine_translation` (1607-1698行)

#### 修改前
```python
system_prompt = f"""你是一位专业的翻译修正专家。请根据原文和回译结果修正以下译文。

{self._build_terminology_prompt(terminology_db, to_refine_sources)}

【重要】输出格式要求：
- 必须使用<textarea>标签包裹所有修正后的译文
- 每行修正译文前必须加上序号（如1. 2. 3.）
- 不要添加任何额外的标题、前缀或说明文字"""
```

**问题**：
- 没有强调术语表的强制性
- 没有说明如何处理回译差异
- 可能导致修正时改掉正确的术语翻译

#### 修改后
```python
system_prompt = f"""你是一位专业的翻译修正专家。请根据原文和回译结果修正以下译文。

{self._build_terminology_prompt(terminology_db, to_refine_sources)}

🔥【强制要求-术语表必须严格遵守】🔥
- 如果原文中出现术语表中的任何术语，修正后的译文必须使用术语表中指定的翻译
- 绝对不允许用其他翻译替代术语表中的术语
- 这是强制性要求，不可违反
- 例如：如果术语表规定"phosphatidylinositol"必须翻译为"磷脂酰肌醇"，则修正时必须使用这个翻译
- 例如：如果术语表规定"Beclin"必须翻译为"Beclin"，则修正时不能改成"贝克林"
- 术语表的翻译优先级最高，即使回译结果显示有差异，也必须保持术语表规定的译法

【修正原则】
- 如果回译与原文的差异是由于术语翻译不一致导致的，不要修正译文，因为术语已经是正确的
- 只修正真正的语义错误、语法错误或流畅性问题
- 修正时必须保持术语表规定的所有术语翻译不变
```

**改进**：
- ✅ 强制要求保持术语表不变
- ✅ 明确说明"即使回译有差异，也不要改动术语"
- ✅ 提供具体的修正原则
- ✅ 区分术语不一致和真正的翻译错误

---

## 📊 修复总结

### TEaR流程各阶段的术语表策略

| 阶段 | 修改前 | 修改后 | 效果 |
|------|--------|--------|------|
| **T (Translate)** | 提示遵守术语表 | 🔥强制遵守术语表 | 确保正向翻译正确 |
| **E (Estimate) - 回译** | 建议还原术语 | 🔥强制还原术语 | 确保回译准确 |
| **E (Estimate) - 评估** | 检查术语一致性 | 🔥容忍术语表述差异 | 避免误判 |
| **R (Refine)** | 一般性修正提示 | 🔥禁止修改术语 | 保护正确翻译 |

### 核心改进原则

#### 1. 正向流程：强制遵守
- 正向翻译（T）：必须使用术语表翻译
- 回译（E）：必须还原为原文术语

#### 2. 评估流程：智能容忍
- 质量评估（E）：容忍术语表述差异，只关注语义准确性

#### 3. 修正流程：保护术语
- 修正（R）：即使回译有差异，也不修改术语表规定的翻译

---

## 🎯 预期效果

### 修复前的问题流程
```
正向翻译: "phosphatidylinositol" → "磷脂酰肌醇" ✓ (正确)
回译:      "磷脂酰肌醇" → "phospholipid inositol" ✗ (不准确)
评估:      发现不一致 → 标记为需要修正 ✗
修正:      改为"磷酸肌醇" ✗ (错误！)
```

### 修复后的正确流程

#### 场景1: 回译准确
```
正向翻译: "phosphatidylinositol" → "磷脂酰肌醇" ✓
回译:      "磷脂酰肌醇" → "phosphatidylinositol" ✓ (强制还原)
评估:      完全一致 → 无需修正 ✓
最终:      "磷脂酰肌醇" ✓ (保持正确)
```

#### 场景2: 回译不准确但语义接近
```
正向翻译: "phosphatidylinositol" → "磷脂酰肌醇" ✓
回译:      "磷脂酰肌醇" → "phospholipid inositol" ⚠ (术语不精确但语义接近)
评估:      差异仅为术语表述 → 无需修正 ✓ (容忍术语差异)
最终:      "磷脂酰肌醇" ✓ (保持正确)
```

#### 场景3: 回译不准确且评估认为需要修正
```
正向翻译: "phosphatidylinositol" → "磷脂酰肌醇" ✓
回译:      "磷脂酰肌醇" → "lipid molecule" ✗ (语义完全不对)
评估:      语义偏差严重 → 需要修正 ⚠
修正:      保持术语表规定："磷脂酰肌醇"，只修正周边语境 ✓ (保护术语)
最终:      "磷脂酰肌醇" ✓ (术语保持正确)
```

---

## 🔍 验证方法

### 重新运行翻译后，观察：

#### 1. 回译阶段的日志
应该看到LLM严格还原术语：
```
→ 批量回译...
✓ 批量回译完成: 12 行
```

检查回译结果，术语应该与原文完全一致。

#### 2. 质量评估的结果
应该看到更少的"需要修正"：
```
→ 批量质量评估...
✓ 评估完成: 1/12 行需要修正  (之前可能是 5/12)
```

因为评估器现在容忍术语表述差异。

#### 3. 实体一致性检查
应该看到更多"个实体翻译正确"：
```
⚠ 发现 2 处实体一致性问题，10 个实体翻译正确  (之前是 0 个正确)
```

#### 4. 最终翻译结果
所有术语应该严格遵守术语表，不会被修正阶段改错。

---

## 📝 技术细节

### 术语表传递链路

```
TerminologyEntityAgent (识别术语)
    ↓
terminology_db (存储在task_memory)
    ↓
TranslationRefinementAgent (翻译)
    ├→ _strategy_based_batch_translation (正向翻译)
    │   └→ _build_terminology_prompt (正向: 原文→译文)
    │
    ├→ _batch_back_translate (回译)
    │   └→ _build_terminology_prompt_for_backtranslation (反向: 译文→原文)
    │
    ├→ _batch_estimate_quality (评估)
    │   └→ 容忍术语表述差异
    │
    └→ _batch_refine_translation (修正)
        └→ _build_terminology_prompt (正向: 原文→译文)
```

### 关键方法

1. **`_build_terminology_prompt`** (1013-1075行)
   - 用于正向翻译和修正阶段
   - 筛选标准：原文中出现的术语
   - 格式：`原文|译文|备注`

2. **`_build_terminology_prompt_for_backtranslation`** (1077-1120行)
   - 用于回译阶段
   - 筛选标准：译文中出现的术语
   - 格式：`译文|原文|备注` (反向)

---

## ✅ 结论

通过强化整个TEaR流程的术语表遵守机制：

1. **回译阶段**：强制还原术语 → 确保回译准确
2. **评估阶段**：容忍术语差异 → 避免误判
3. **修正阶段**：保护术语不变 → 防止改错

**实体一致性问题应该得到显著改善！** 🎉

现在请重新运行翻译，观察实体一致性检查的结果。

