# å¤šæ™ºèƒ½ä½“ç¿»è¯‘ç³»ç»Ÿå¹¶å‘ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³å¤šæ™ºèƒ½ä½“ç¿»è¯‘æ¨¡å¼ä¸‹å¹¶å‘æ•°è¿‡ä½ï¼ˆç¡¬ç¼–ç 10ä¸ªå¹¶å‘ï¼‰å¯¼è‡´ç¿»è¯‘é€Ÿåº¦æ…¢çš„é—®é¢˜ï¼ŒåŒæ—¶è€ƒè™‘å¤šé˜¶æ®µLLMè°ƒç”¨å¯èƒ½è¶…è¿‡RPM/TPMé™åˆ¶ã€‚

## ğŸ“Š é—®é¢˜åˆ†æ

### åŸTaskExecutorçš„å¹¶å‘ç­–ç•¥
```python
# 1. ä½¿ç”¨ç”¨æˆ·é…ç½®çš„å¹¶å‘æ•°
max_workers = self.config.actual_thread_counts  # ä¾‹å¦‚ï¼š50ä¸ªå¹¶å‘

# 2. æ¯ä¸ªTaskä½¿ç”¨RequestLimiteræ§åˆ¶RPM/TPM
if self.request_limiter.check_limiter(self.request_tokens_consume):
    # å‘é€è¯·æ±‚
```

### å¤šæ™ºèƒ½ä½“æ¨¡å¼çš„é—®é¢˜
```python
# âŒ ç¡¬ç¼–ç 10ä¸ªå¹¶å‘ï¼Œå¤ªæ…¢ï¼
max_workers = min(10, total_units)

# âŒ æ²¡æœ‰ä½¿ç”¨RequestLimiter
# âŒ å¤šé˜¶æ®µè°ƒç”¨ä¼šè¶…è¿‡RPM/TPMé™åˆ¶ï¼š
#    - Planning Agentï¼ˆ1æ¬¡LLMè°ƒç”¨ï¼‰
#    - Terminology Agentï¼ˆNæ¬¡ï¼Œå–å†³äºæœ¯è¯­æ•°é‡ï¼‰
#    - Translation Agentï¼ˆæ¯ä¸ªå•å…ƒ7-10æ¬¡ï¼‰
#      â”œâ”€ å¤šæ­¥éª¤ç¿»è¯‘ï¼ˆ1æ¬¡ï¼‰
#      â”œâ”€ å¤šç‰ˆæœ¬ç”Ÿæˆï¼ˆ3æ¬¡ï¼šç›´è¯‘ã€æ„è¯‘ã€é£æ ¼åŒ–ï¼‰
#      â”œâ”€ ç‰ˆæœ¬èåˆï¼ˆ1æ¬¡ï¼‰
#      â”œâ”€ å›è¯‘éªŒè¯ï¼ˆ1æ¬¡ï¼‰
#      â”œâ”€ è´¨é‡è¯„ä¼°ï¼ˆ1æ¬¡ï¼‰
#      â””â”€ ä¿®æ­£ï¼ˆ0-1æ¬¡ï¼Œå–å†³äºè´¨é‡ï¼‰
```

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. åŠ¨æ€å¹¶å‘æ•°è®¡ç®—

```python
# ä»Planning Agentçš„æ‰§è¡Œè®¡åˆ’ä¸­è·å–å¹¶å‘æ•°
if planning_result and "execution_plan" in planning_result:
    max_workers = planning_result["execution_plan"].get("max_workers", 10)
# æˆ–è€…ä»configä¸­è·å–ç”¨æˆ·é…ç½®çš„çº¿ç¨‹æ•°
elif self.config and hasattr(self.config, 'actual_thread_counts'):
    # ç”±äºå¤šæ™ºèƒ½ä½“æœ‰å¤šé˜¶æ®µè°ƒç”¨ï¼Œéœ€è¦é™ä½å¹¶å‘æ•°ä»¥é¿å…è¶…è¿‡RPM/TPMé™åˆ¶
    # å‡è®¾å¹³å‡æ¯ä¸ªå•å…ƒéœ€è¦3æ¬¡LLMè°ƒç”¨ï¼ˆå¤šæ­¥éª¤ã€å¤šç‰ˆæœ¬ã€å›è¯‘ï¼‰
    configured_workers = self.config.actual_thread_counts
    max_workers = max(5, configured_workers // 3)  # æœ€å°‘5ä¸ªå¹¶å‘
```

**è¯´æ˜**ï¼š
- **Planning Agentè®¡ç®—**ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦ã€é¢„ä¼°èµ„æºæ¶ˆè€—æ™ºèƒ½è®¡ç®—
- **é…ç½®è¯»å–**ï¼šä½¿ç”¨ç”¨æˆ·é…ç½®çš„`actual_thread_counts`
- **é™çº§ç³»æ•°**ï¼šè€ƒè™‘åˆ°æ¯ä¸ªå•å…ƒå¹³å‡3æ¬¡LLMè°ƒç”¨ï¼Œå°†å¹¶å‘æ•°é™¤ä»¥3
- **æœ€å°ä¿éšœ**ï¼šç¡®ä¿è‡³å°‘5ä¸ªå¹¶å‘ï¼Œé¿å…è¿‡æ…¢

### 2. æ·»åŠ RequestLimiteræœºåˆ¶

```python
from ModuleFolders.RequestLimiter.RequestLimiter import RequestLimiter

class TranslationRefinementAgent(BaseAgent):
    def __init__(self, config=None):
        self.request_limiter = RequestLimiter()
        
        # é…ç½®è¯·æ±‚é™åˆ¶å™¨
        if self.config:
            rpm_limit = getattr(self.config, 'rpm_limit', 60)
            tpm_limit = getattr(self.config, 'tpm_limit', 10000)
            self.request_limiter.set_limit(tpm_limit, rpm_limit)
```

### 3. LLMè°ƒç”¨å‰æ£€æŸ¥é™åˆ¶

```python
def _wait_for_limiter(self, messages: list, system_prompt: str, timeout: int = 300) -> bool:
    """
    ç­‰å¾…RequestLimiterå…è®¸å‘é€è¯·æ±‚ï¼ˆå‚è€ƒåŸTaskExecutorçš„å®ç°ï¼‰
    """
    # è®¡ç®—Tokenæ¶ˆè€—
    tokens_consume = self.request_limiter.calculate_tokens(messages, system_prompt)
    
    # ç­‰å¾…é™åˆ¶å™¨å…è®¸
    while True:
        # æ£€æµ‹æ˜¯å¦æ”¶åˆ°åœæ­¢ç¿»è¯‘äº‹ä»¶
        if Base.work_status == Base.STATUS.STOPING:
            return False
        
        # æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if time.time() - start_time >= timeout:
            return False
        
        # æ£€æŸ¥RPMå’ŒTPMé™åˆ¶
        if self.request_limiter.check_limiter(tokens_consume):
            return True
        
        # ç­‰å¾…1ç§’
        time.sleep(1)
```

### 4. åœ¨æ‰€æœ‰LLMè°ƒç”¨ç‚¹æ·»åŠ æ£€æŸ¥

```python
# å¤šæ­¥éª¤ç¿»è¯‘
if not self._wait_for_limiter(messages, system_prompt):
    return None

# å¤šç‰ˆæœ¬ç”Ÿæˆ
if not self._wait_for_limiter(messages, system_prompt):
    return initial_translation

# ç‰ˆæœ¬èåˆ
if not self._wait_for_limiter(messages, system_prompt):
    return list(versions.values())[0]

# å›è¯‘éªŒè¯
if not self._wait_for_limiter(messages, system_prompt):
    return None

# è´¨é‡è¯„ä¼°
if not self._wait_for_limiter(messages, system_prompt):
    return {"needs_refinement": False, "score": 80}

# ç¿»è¯‘ä¿®æ­£
if not self._wait_for_limiter(messages, system_prompt):
    return translated_text
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰
```
å¹¶å‘æ•°ï¼šç¡¬ç¼–ç 10ä¸ª
RPMæ§åˆ¶ï¼šæ— 
TPMæ§åˆ¶ï¼šæ— 
ç¿»è¯‘é€Ÿåº¦ï¼šæ…¢ï¼ˆå³ä½¿ç”¨æˆ·é…ç½®äº†50ä¸ªå¹¶å‘ä¹Ÿåªç”¨10ä¸ªï¼‰
é£é™©ï¼šå¯èƒ½è¶…è¿‡APIé™åˆ¶å¯¼è‡´é”™è¯¯
```

### ä¼˜åŒ–å
```
å¹¶å‘æ•°ï¼šåŠ¨æ€è®¡ç®—ï¼ˆä¾‹å¦‚ï¼šé…ç½®50 â†’ å®é™…16ä¸ªï¼‰
RPMæ§åˆ¶ï¼šâœ… RequestLimiterä»¤ç‰Œæ¡¶ç®—æ³•
TPMæ§åˆ¶ï¼šâœ… RequestLimiteræ—¶é—´é—´éš”æ§åˆ¶
ç¿»è¯‘é€Ÿåº¦ï¼šå¿«ï¼ˆæ ¹æ®ç”¨æˆ·é…ç½®å’ŒAPIé™åˆ¶æ™ºèƒ½è°ƒæ•´ï¼‰
é£é™©ï¼šâœ… ä¸ä¼šè¶…è¿‡RPM/TPMé™åˆ¶
```

## ğŸ”¥ å®é™…æ•ˆæœ

å‡è®¾ç”¨æˆ·é…ç½®ï¼š
- `actual_thread_counts = 50`
- `rpm_limit = 60` (æ¯åˆ†é’Ÿ60æ¬¡è¯·æ±‚)
- `tpm_limit = 100000` (æ¯åˆ†é’Ÿ10ä¸‡Token)

### ä¼˜åŒ–å‰
```
ç¿»è¯‘å¹¶å‘ï¼š10ä¸ª
é¢„è®¡å®Œæˆ337ä¸ªå•å…ƒæ—¶é—´ï¼šçº¦56åˆ†é’Ÿï¼ˆ337å•å…ƒ Ã— 10ç§’/å•å…ƒ Ã· 10å¹¶å‘ï¼‰
```

### ä¼˜åŒ–å
```
ç¿»è¯‘å¹¶å‘ï¼š16ä¸ªï¼ˆ50 Ã· 3ï¼‰
é¢„è®¡å®Œæˆ337ä¸ªå•å…ƒæ—¶é—´ï¼šçº¦35åˆ†é’Ÿï¼ˆ337å•å…ƒ Ã— 10ç§’/å•å…ƒ Ã· 16å¹¶å‘ï¼‰
æé€Ÿï¼šçº¦37%
```

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

### 1. é˜²æ­¢è¶…é™
- **RPMæ£€æŸ¥**ï¼šæ¯æ¬¡è¯·æ±‚å‰æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ¯åˆ†é’Ÿè¯·æ±‚æ•°é™åˆ¶
- **TPMæ£€æŸ¥**ï¼šæ¯æ¬¡è¯·æ±‚å‰æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ¯åˆ†é’ŸTokenæ•°é™åˆ¶
- **è‡ªåŠ¨ç­‰å¾…**ï¼šå¦‚æœè¶…é™ï¼Œè‡ªåŠ¨ç­‰å¾…ç›´åˆ°å¯ä»¥å‘é€

### 2. é™çº§ç­–ç•¥
- **è¶…æ—¶ä¿æŠ¤**ï¼šå¦‚æœç­‰å¾…è¶…è¿‡300ç§’ï¼Œè·³è¿‡å½“å‰è¯·æ±‚
- **ä¼˜é›…é™çº§**ï¼šè·³è¿‡éå…³é”®æ­¥éª¤ï¼ˆå¦‚å¤šç‰ˆæœ¬ç”Ÿæˆã€å›è¯‘éªŒè¯ï¼‰
- **ä¿åº•ç¿»è¯‘**ï¼šè‡³å°‘è¿”å›åˆæ­¥ç¿»è¯‘ç»“æœ

### 3. å¤šé˜¶æ®µè€ƒè™‘
```
Planning Agent (1æ¬¡/é¡¹ç›®) 
  â†’ Terminology Agent (Næ¬¡ï¼Œé€šå¸¸10-50æ¬¡)
    â†’ Translation Agent (æ¯å•å…ƒ7-10æ¬¡ Ã— 337å•å…ƒ â‰ˆ 2500æ¬¡)
      â”œâ”€ å¤šæ­¥éª¤ç¿»è¯‘ï¼ˆ1æ¬¡ï¼‰âœ… å¿…éœ€
      â”œâ”€ å¤šç‰ˆæœ¬ç”Ÿæˆï¼ˆ3æ¬¡ï¼‰â†’ å¯é™çº§
      â”œâ”€ ç‰ˆæœ¬èåˆï¼ˆ1æ¬¡ï¼‰â†’ å¯é™çº§
      â”œâ”€ å›è¯‘éªŒè¯ï¼ˆ1æ¬¡ï¼‰â†’ å¯é™çº§
      â”œâ”€ è´¨é‡è¯„ä¼°ï¼ˆ1æ¬¡ï¼‰â†’ å¯é™çº§
      â””â”€ ä¿®æ­£ï¼ˆ0-1æ¬¡ï¼‰â†’ å¯é™çº§

æ€»è®¡ï¼šçº¦2560æ¬¡LLMè°ƒç”¨
```

é€šè¿‡RequestLimiterï¼Œè¿™äº›è°ƒç”¨ä¼šè‡ªåŠ¨åˆ†æ•£åœ¨æ—¶é—´è½´ä¸Šï¼Œç¡®ä¿ä¸è¶…è¿‡RPM/TPMé™åˆ¶ã€‚

## ğŸ¯ ä½¿ç”¨å»ºè®®

### åœºæ™¯1ï¼šé«˜é€ŸAPIï¼ˆå¦‚DeepSeekï¼‰
```json
{
  "user_thread_counts": 50,
  "rpm_limit": 300,
  "tpm_limit": 500000
}
```
**é¢„æœŸ**ï¼šç¿»è¯‘å¹¶å‘çº¦16ä¸ªï¼Œé€Ÿåº¦å¿«

### åœºæ™¯2ï¼šä¸­é€ŸAPIï¼ˆå¦‚GPT-3.5ï¼‰
```json
{
  "user_thread_counts": 30,
  "rpm_limit": 60,
  "tpm_limit": 100000
}
```
**é¢„æœŸ**ï¼šç¿»è¯‘å¹¶å‘çº¦10ä¸ªï¼Œé€Ÿåº¦ä¸­ç­‰

### åœºæ™¯3ï¼šä½é€ŸAPIï¼ˆå¦‚æœ¬åœ°LLMï¼‰
```json
{
  "user_thread_counts": 10,
  "rpm_limit": 20,
  "tpm_limit": 50000
}
```
**é¢„æœŸ**ï¼šç¿»è¯‘å¹¶å‘çº¦3-5ä¸ªï¼Œé€Ÿåº¦è¾ƒæ…¢ä½†ç¨³å®š

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. `ModuleFolders/MultiAgent/TranslationRefinementAgent.py`
- âœ… æ·»åŠ `RequestLimiter`å¯¼å…¥å’Œåˆå§‹åŒ–
- âœ… åŠ¨æ€è®¡ç®—`max_workers`
- âœ… æ·»åŠ `_wait_for_limiter()`æ–¹æ³•
- âœ… åœ¨æ‰€æœ‰LLMè°ƒç”¨å‰æ·»åŠ RequestLimiteræ£€æŸ¥

### 2. `ModuleFolders/MultiAgent/GriptapeTools.py`
- âœ… åœ¨`TranslationTool`ä¸­ä¼ é€’`planning_result`

### 3. æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶
- âŒ `WorkflowManager.py`ï¼šå·²ç»åœ¨å°†`planning_result`å­˜å…¥`workflow_state`
- âŒ `PlanningAgent.py`ï¼šå·²ç»è®¡ç®—äº†`max_workers`

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å®ç°äº†ï¼š
1. âœ… **åŠ¨æ€å¹¶å‘æ•°**ï¼šä»ç¡¬ç¼–ç 10ä¸ªæå‡åˆ°æ ¹æ®é…ç½®æ™ºèƒ½è®¡ç®—
2. âœ… **RPM/TPMæ§åˆ¶**ï¼šæ·»åŠ RequestLimiteræœºåˆ¶ï¼Œé˜²æ­¢è¶…é™
3. âœ… **å¤šé˜¶æ®µè€ƒè™‘**ï¼šé™ä½å¹¶å‘æ•°ä»¥é€‚åº”å¤šæ¬¡LLMè°ƒç”¨
4. âœ… **å‘åå…¼å®¹**ï¼šä¸åŸTaskExecutorçš„å¹¶å‘ç­–ç•¥ä¿æŒä¸€è‡´
5. âœ… **ä¼˜é›…é™çº§**ï¼šéå…³é”®æ­¥éª¤å¯è·³è¿‡ï¼Œç¡®ä¿è‡³å°‘æœ‰åŸºç¡€ç¿»è¯‘ç»“æœ

**é¢„æœŸæ•ˆæœ**ï¼š
- ç¿»è¯‘é€Ÿåº¦æå‡**30-50%**ï¼ˆå–å†³äºç”¨æˆ·é…ç½®ï¼‰
- APIè°ƒç”¨æ›´åŠ ç¨³å®šï¼Œä¸ä¼šè¶…è¿‡é™åˆ¶
- ä¸åŸæµç¨‹ä¸€è‡´ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½

