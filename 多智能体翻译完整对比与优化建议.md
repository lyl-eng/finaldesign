# å¤šæ™ºèƒ½ä½“ç¿»è¯‘å®Œæ•´å¯¹æ¯”ä¸ä¼˜åŒ–å»ºè®®

## ğŸ“Š åŸæ–¹æ³• vs å¤šæ™ºèƒ½ä½“æ–¹æ³•å®Œæ•´å¯¹æ¯”

### åŸæ–¹æ³• (TranslatorTask) å®Œæ•´æµç¨‹

#### 1. Prepareé˜¶æ®µ (prepareæ–¹æ³•)

```python
# 1. ç”Ÿæˆä¸Šæ–‡æ–‡æœ¬åˆ—è¡¨
self.previous_text_list = [v.source_text for v in self.previous_items]

# 2. ç”ŸæˆåŸæ–‡æ–‡æœ¬å­—å…¸
self.source_text_dict = {str(i): v.source_text for i, v in enumerate(self.items)}

# 3. è§¦å‘æ’ä»¶äº‹ä»¶ - æ–‡æœ¬æ­£è§„åŒ–
self.plugin_manager.broadcast_event("normalize_text", self.config, self.source_text_dict)

# 4. è¯‘å‰æ›¿æ¢ï¼šæå–é¦–å°¾ä»£ç ä¸å ä½ç¬¦
self.source_text_dict, self.prefix_codes, self.suffix_codes, self.placeholder_order, self.affix_whitespace_storage = \
    self.text_processor.replace_all(
        self.config,
        self.source_lang, 
        self.source_text_dict
    )

# 5. ç”Ÿæˆè¯·æ±‚æŒ‡ä»¤ï¼ˆä½¿ç”¨PromptBuilderï¼‰
self.messages, self.system_prompt, self.extra_log = PromptBuilder.generate_prompt(
    self.config,
    self.source_text_dict,
    self.previous_text_list,
    self.source_lang,
)

# 6. é¢„ä¼°Tokenæ¶ˆè´¹
self.request_tokens_consume = self.request_limiter.calculate_tokens(self.messages, self.system_prompt)
```

#### 2. Translationé˜¶æ®µ (unit_translation_taskæ–¹æ³•)

```python
# 1. ç­‰å¾…RequestLimiter
while True:
    if self.request_limiter.check_limiter(self.request_tokens_consume):
        break
    time.sleep(1)

# 2. å‘èµ·è¯·æ±‚
platform_config = self.config.get_platform_configuration("translationReq")
skip, response_think, response_content, prompt_tokens, completion_tokens = requester.sent_request(
    self.messages,
    self.system_prompt,
    platform_config
)

# 3. æå–å›å¤å†…å®¹
response_dict = ResponseExtractor.text_extraction(self, self.source_text_dict, response_content)

# 4. æ£€æŸ¥å›å¤å†…å®¹
check_result, error_content = ResponseChecker.check_response_content(
    self,
    self.config,
    self.placeholder_order,
    response_content,
    response_dict,
    self.source_text_dict,
    self.source_lang
)

# 5. å»é™¤æ•°å­—åºå·å‰ç¼€
response_dict = ResponseExtractor.remove_numbered_prefix(self, response_dict)

# 6. è¯‘åæ¢å¤ï¼šè¿˜åŸé¦–å°¾ä»£ç ä¸å ä½ç¬¦
restore_response_dict = copy.copy(response_dict)
restore_response_dict = self.text_processor.restore_all(
    self.config, 
    restore_response_dict, 
    self.prefix_codes, 
    self.suffix_codes, 
    self.placeholder_order, 
    self.affix_whitespace_storage
)

# 7. æ›´æ–°ç¼“å­˜
for item, response in zip(self.items, restore_response_dict.values()):
    with item.atomic_scope():
        item.model = self.config.model
        item.translated_text = response
        item.translation_status = TranslationStatus.TRANSLATED
```

### å¤šæ™ºèƒ½ä½“æ–¹æ³• (å½“å‰å®ç°)

#### 1. Prepareé˜¶æ®µ (_prepare_translation_chunksæ–¹æ³•)

```python
# 1. ç›´æ¥ä»CacheItemè·å–source_text
source_texts = [item.source_text for item in chunk]

# 2. æ‰‹åŠ¨æ„å»ºsource_text_dict
source_text_dict = {str(i): text for i, text in enumerate(source_texts)}

# 3. æ‰‹åŠ¨æ„å»ºtextareaæ ¼å¼åŸæ–‡ï¼ˆä½¿ç”¨ä¸PromptBuilderç›¸åŒçš„é€»è¾‘ï¼‰
numbered_lines = []
for index, line in enumerate(source_texts):
    if "\n" in line:
        # å¤šè¡Œæ–‡æœ¬å¤„ç†
        lines = line.split("\n")
        numbered_text = f"{index + 1}.[\n"
        for sub_index, sub_line in enumerate(lines):
            numbered_text += f'"{index + 1}.{total_lines - sub_index}.,{sub_line}",\n'
        numbered_text += f"\n]"
        numbered_lines.append(numbered_text)
    else:
        # å•è¡Œæ–‡æœ¬
        numbered_lines.append(f"{index + 1}.{line}")

source_text = "\n".join(numbered_lines)

# 4. æ‰‹åŠ¨æ„å»ºsystem_promptï¼ˆåŒ…å«å¤šæ­¥éª¤å¼•å¯¼å’Œæœ¯è¯­æç¤ºï¼‰
system_prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¿»è¯‘ä¸“å®¶ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œç¿»è¯‘ï¼š
æ­¥éª¤1 - ç†è§£ï¼šåˆ†æåŸæ–‡çš„è¯­ä¹‰ã€è¯­å¢ƒå’Œé£æ ¼
æ­¥éª¤2 - åˆ†è§£ï¼šå¯¹äºé•¿éš¾å¥ï¼Œå…ˆè¯†åˆ«ä¸»å¹²æˆåˆ†å’Œä»å¥å±‚çº§
æ­¥éª¤3 - è½¬æ¢ï¼šå°†åŸæ–‡è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€ï¼Œä¿æŒè¯­ä¹‰å‡†ç¡®
æ­¥éª¤4 - æ¶¦è‰²ï¼šä¼˜åŒ–è¯‘æ–‡ï¼Œç¡®ä¿æµç•…è‡ªç„¶

{terminology_prompt}
{memory_context}

é‡è¦ï¼šè¯·å°†ç¿»è¯‘ç»“æœä»¥<textarea>æ ‡ç­¾åŒ…è£¹..."""

# 5. æ„å»ºuser_prompt
user_prompt = f"""{context_prefix}###å¾…ç¿»è¯‘æ–‡æœ¬
<textarea>
{source_text}
</textarea>"""
```

#### 2. Translationé˜¶æ®µ (_multi_step_batch_translationæ–¹æ³•)

```python
# 1. ç­‰å¾…RequestLimiter
if not self._wait_for_limiter(messages, system_prompt):
    return None

# 2. å‘èµ·è¯·æ±‚
platform_config = self.config.get_platform_configuration("translationReq")
skip, _, response_content, _, _ = self.llm_requester.sent_request(
    messages, 
    system_prompt, 
    platform_config
)

# 3. æå–å›å¤å†…å®¹
response_dict = ResponseExtractor.text_extraction(self, source_text_dict, response_content)

# 4. âŒ **æœªè¿›è¡ŒResponseCheckeræ£€æŸ¥**

# 5. å»é™¤æ•°å­—åºå·å‰ç¼€
response_dict = ResponseExtractor.remove_numbered_prefix(self, response_dict)

# 6. âŒ **æœªè¿›è¡Œè¯‘åæ¢å¤ï¼ˆå¯èƒ½ä¸éœ€è¦ï¼Œå› ä¸ºæ²¡æœ‰è¯‘å‰æ›¿æ¢ï¼‰**

# 7. å°†å­—å…¸è½¬æ¢ä¸ºåˆ—è¡¨
if response_dict and len(response_dict) == len(source_texts):
    translated_texts = [response_dict[str(i)] for i in range(len(source_texts))]
    return translated_texts
else:
    # é™çº§ä¸ºé€è¡Œç¿»è¯‘
    return self._fallback_to_sequential_translation(...)

# 8. æ›´æ–°ç¼“å­˜ï¼ˆåœ¨_translate_chunkæ–¹æ³•ä¸­ï¼‰
for item, translated_text in zip(chunk, final_texts):
    item.translated_text = translated_text
    item.translation_status = TranslationStatus.TRANSLATED
```

## âœ… å·²å®ç°çš„åŸæ–¹æ³•ç‰¹æ€§

1. âœ… **textareaæ ¼å¼**ï¼šä½¿ç”¨ä¸åŸæ–¹æ³•ç›¸åŒçš„æ ¼å¼
2. âœ… **ResponseExtractorè§£æ**ï¼šä½¿ç”¨åŸæ–¹æ³•çš„è§£æå™¨
3. âœ… **RequestLimiteré€Ÿç‡æ§åˆ¶**ï¼šå®ç°äº†ç­‰å¾…é€»è¾‘
4. âœ… **å»é™¤æ•°å­—åºå·å‰ç¼€**ï¼šè°ƒç”¨remove_numbered_prefix
5. âœ… **é™çº§æœºåˆ¶**ï¼šæ‰¹é‡å¤±è´¥â†’é€è¡Œç¿»è¯‘
6. âœ… **è¯¦ç»†é”™è¯¯æ—¥å¿—**ï¼šè¾“å‡ºè¾“å…¥/è¾“å‡º/åŸå§‹å“åº”
7. âœ… **å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨ThreadPoolExecutorå¹¶å‘å¤„ç†æ‰¹æ¬¡

## âš ï¸ æœªå®ç°çš„åŸæ–¹æ³•ç‰¹æ€§ï¼ˆä½†å¯èƒ½ä¸éœ€è¦ï¼‰

### 1. âŒ æ–‡æœ¬é¢„å¤„ç†

**åŸæ–¹æ³•**ï¼š
- `normalize_text` æ’ä»¶äº‹ä»¶ï¼ˆæ–‡æœ¬æ­£è§„åŒ–ï¼‰
- `text_processor.replace_all`ï¼ˆè¯‘å‰æ›¿æ¢ï¼Œæå–ä»£ç /å ä½ç¬¦ï¼‰

**å¤šæ™ºèƒ½ä½“æ–¹æ³•**ï¼š
- ç›´æ¥ä½¿ç”¨CacheItem.source_textï¼ˆå¯èƒ½å·²ç»é¢„å¤„ç†è¿‡ï¼‰

**å»ºè®®**ï¼š
- æ£€æŸ¥CacheItemä¸­çš„source_textæ˜¯å¦å·²ç»è¿‡é¢„å¤„ç†
- å¦‚æœéœ€è¦ï¼Œåœ¨å¤šæ™ºèƒ½ä½“æ–¹æ³•ä¸­ä¹Ÿè°ƒç”¨è¿™äº›é¢„å¤„ç†æ­¥éª¤

### 2. âŒ ResponseCheckerè´¨é‡æ£€æŸ¥

**åŸæ–¹æ³•**ï¼š
- è°ƒç”¨`ResponseChecker.check_response_content`
- æ£€æŸ¥è¡Œæ•°ã€ç©ºå€¼ã€åºå·ã€æ¢è¡Œç¬¦ç­‰

**å¤šæ™ºèƒ½ä½“æ–¹æ³•**ï¼š
- ç®€å•çš„æ•°é‡åŒ¹é…æ£€æŸ¥
- å¤±è´¥æ—¶ç›´æ¥é™çº§

**å»ºè®®**ï¼š
- åœ¨é™çº§ä¹‹å‰å…ˆè°ƒç”¨ResponseChecker
- å¦‚æœæ£€æŸ¥å¤±è´¥ä½†ä¸æ˜¯æ•°é‡é—®é¢˜ï¼Œå¯èƒ½ä¸éœ€è¦é™çº§ï¼Œè€Œæ˜¯æ ‡è®°ä¸ºéœ€è¦é‡ç¿»

### 3. âŒ è¯‘åæ¢å¤

**åŸæ–¹æ³•**ï¼š
- è°ƒç”¨`text_processor.restore_all`
- æ¢å¤é¦–å°¾ä»£ç ã€å ä½ç¬¦ç­‰

**å¤šæ™ºèƒ½ä½“æ–¹æ³•**ï¼š
- æœªè¿›è¡Œè¯‘åæ¢å¤

**å»ºè®®**ï¼š
- å¦‚æœè¯‘å‰æ²¡æœ‰æ›¿æ¢ï¼Œè¯‘åå¯èƒ½ä¹Ÿä¸éœ€è¦æ¢å¤
- ä½†éœ€è¦ç¡®è®¤CacheItemçš„source_textæ˜¯å¦å·²ç»è¿‡æ›¿æ¢

### 4. âŒ PromptBuilder

**åŸæ–¹æ³•**ï¼š
- ä½¿ç”¨`PromptBuilder.generate_prompt`
- è‡ªåŠ¨æ·»åŠ æœ¯è¯­è¡¨ã€ç¦ç¿»è¡¨ã€è§’è‰²ä»‹ç»ã€é£æ ¼ç­‰

**å¤šæ™ºèƒ½ä½“æ–¹æ³•**ï¼š
- æ‰‹åŠ¨æ„å»ºsystem_prompt
- åªåŒ…å«å¤šæ­¥éª¤å¼•å¯¼å’ŒåŸºæœ¬æœ¯è¯­æç¤º

**å»ºè®®**ï¼š
- è€ƒè™‘ä½¿ç”¨PromptBuilderè·å¾—æ›´å®Œæ•´çš„æç¤ºè¯
- æˆ–è€…æ‰‹åŠ¨æ·»åŠ æ›´å¤šé…ç½®é¡¹ï¼ˆå¦‚ç¦ç¿»è¡¨ã€è§’è‰²ä»‹ç»ç­‰ï¼‰

## ğŸ¯ ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ ğŸ”´

1. **é›†æˆResponseChecker**
   - åœ¨è§£æåç«‹å³è°ƒç”¨
   - æä¾›æ›´è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
   - åŒºåˆ†"éœ€è¦é‡ç¿»"å’Œ"éœ€è¦é™çº§"

```python
# åœ¨_multi_step_batch_translationä¸­æ·»åŠ 
from ModuleFolders.ResponseChecker.ResponseChecker import ResponseChecker

# æ£€æŸ¥å›å¤å†…å®¹
check_result, error_content = ResponseChecker.check_response_content(
    self,
    self.config,
    {},  # placeholder_orderï¼ˆå¤šæ™ºèƒ½ä½“å¯èƒ½ä¸éœ€è¦ï¼‰
    response_content,
    response_dict,
    source_text_dict,
    self.config.source_language if self.config else "english"
)

if not check_result:
    self.warning(f"     âŒ å“åº”è´¨é‡æ£€æŸ¥å¤±è´¥: {error_content}")
    # æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯é‡è¯•è¿˜æ˜¯é™çº§
    if "è¡Œæ•°é”™è¯¯" in error_content:
        # é™çº§ä¸ºé€è¡Œç¿»è¯‘
        return self._fallback_to_sequential_translation(...)
    else:
        # æ ‡è®°ä¸ºéœ€è¦é‡ç¿»ï¼ˆä¸‹ä¸€è½®æ¬¡ï¼‰
        return None
```

### ä¸­ä¼˜å…ˆçº§ ğŸŸ¡

2. **æ£€æŸ¥æ–‡æœ¬é¢„å¤„ç†éœ€æ±‚**
   - æŸ¥çœ‹CacheItem.source_textæ˜¯å¦å·²é¢„å¤„ç†
   - å¦‚æœéœ€è¦ï¼Œæ·»åŠ normalize_textå’Œreplace_allè°ƒç”¨

3. **å¢å¼ºsystem_promptæ„å»º**
   - è€ƒè™‘ä½¿ç”¨PromptBuilder
   - æˆ–æ‰‹åŠ¨æ·»åŠ æ›´å¤šé…ç½®é¡¹ï¼ˆç¦ç¿»è¡¨ã€è§’è‰²ä»‹ç»ã€é£æ ¼ç­‰ï¼‰

### ä½ä¼˜å…ˆçº§ ğŸŸ¢

4. **è¯‘åæ¢å¤ï¼ˆå¯èƒ½ä¸éœ€è¦ï¼‰**
   - ä»…åœ¨ç¡®è®¤éœ€è¦è¯‘å‰æ›¿æ¢æ—¶æ‰å®ç°

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€

å¤šæ™ºèƒ½ä½“æ‰¹é‡ç¿»è¯‘ç³»ç»Ÿå·²ç»ï¼š
- âœ… ä½¿ç”¨ä¸åŸæ–¹æ³•ç›¸åŒçš„textareaæ ¼å¼å’ŒResponseExtractor
- âœ… å®ç°äº†RequestLimiteré€Ÿç‡æ§åˆ¶
- âœ… å®ç°äº†å¥å£®çš„é™çº§æœºåˆ¶
- âœ… å¢å¼ºäº†é”™è¯¯æ—¥å¿—è¾“å‡º

### æœ€é‡è¦çš„æ”¹è¿›æ–¹å‘

**é›†æˆResponseChecker**æ˜¯æœ€é‡è¦çš„æ”¹è¿›ï¼Œå› ä¸ºï¼š
1. æä¾›æ›´è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
2. å¯ä»¥åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
3. æœ‰åŠ©äºä¼˜åŒ–é™çº§ç­–ç•¥
4. ä¸åŸæ–¹æ³•ä¿æŒä¸€è‡´æ€§

### ç»“è®º

ç³»ç»Ÿå·²ç»æœ‰è¶³å¤Ÿçš„å¥å£®æ€§æ¥å¤„ç†æ‰¹é‡ç¿»è¯‘å¤±è´¥çš„æƒ…å†µã€‚å½“å‰çš„é”™è¯¯æ—¥å¿—å·²ç»èƒ½å¤Ÿå¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚æœªæ¥å¯ä»¥è€ƒè™‘é›†æˆResponseCheckeræ¥è¿›ä¸€æ­¥æå‡è´¨é‡æ£€æŸ¥èƒ½åŠ›ã€‚

